# Zitadel identity provider for Arbor (dev/self-hosted)
# Based on official zitadel/zitadel v4.11.0 compose.
# Stripped of optional Redis cache and OTEL observability profiles.
#
# Usage:
#   cd docker/zitadel
#   docker compose up -d --wait
#   open http://localhost:8080
#
# See README.md for full setup instructions.

name: arbor-zitadel

services:
  proxy:
    image: ${TRAEFIK_IMAGE:-traefik:v3.6.8}
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=arbor-zitadel
      - --entrypoints.web.address=:80
      - --api.dashboard=false
      - --ping=true
      - --ping.entrypoint=web
      - --log.level=WARN
      - --accesslog=false
    ports:
      - "${PROXY_HTTP_PUBLISHED_PORT:-8080}:80"
    networks:
      - arbor-zitadel
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      zitadel-api:
        condition: service_healthy
      zitadel-login:
        condition: service_healthy

  zitadel-api:
    image: ghcr.io/zitadel/zitadel:${ZITADEL_VERSION:-v4.11.0}
    restart: unless-stopped
    user: "0"
    command: start-from-init --masterkey "${ZITADEL_MASTERKEY}"
    environment:
      ZITADEL_PORT: 8080
      ZITADEL_EXTERNALDOMAIN: ${ZITADEL_DOMAIN:-localhost}
      ZITADEL_EXTERNALPORT: ${ZITADEL_EXTERNALPORT:-8080}
      ZITADEL_EXTERNALSECURE: "false"
      ZITADEL_TLS_ENABLED: "false"

      # PostgreSQL
      ZITADEL_DATABASE_POSTGRES_HOST: postgres
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      ZITADEL_DATABASE_POSTGRES_DATABASE: ${POSTGRES_DB:-zitadel}
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: ${POSTGRES_ADMIN_USER:-postgres}
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: ${POSTGRES_ADMIN_PASSWORD:-postgres}
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: ${POSTGRES_ZITADEL_USER:-zitadel}
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: ${POSTGRES_ZITADEL_PASSWORD:-zitadel}
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable

      # Bootstrap
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: "false"
      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: /zitadel/bootstrap/login-client.pat
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: login-client
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: Automatically Initialized IAM_LOGIN_CLIENT
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: ${LOGIN_CLIENT_PAT_EXPIRATION:-2099-01-01T00:00:00Z}

      # Login V2
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: "true"
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: "http://${ZITADEL_DOMAIN:-localhost}:${ZITADEL_EXTERNALPORT:-8080}/ui/v2/login/"
      ZITADEL_OIDC_DEFAULTLOGINURLV2: "http://${ZITADEL_DOMAIN:-localhost}:${ZITADEL_EXTERNALPORT:-8080}/ui/v2/login/login?authRequest="
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: "http://${ZITADEL_DOMAIN:-localhost}:${ZITADEL_EXTERNALPORT:-8080}/ui/v2/login/logout?post_logout_redirect="

      ZITADEL_LOGSTORE_ACCESS_STDOUT_ENABLED: "true"
    healthcheck:
      test: [CMD, /app/zitadel, ready]
      interval: 10s
      timeout: 30s
      retries: 12
      start_period: 20s
    volumes:
      - zitadel-bootstrap:/zitadel/bootstrap:rw
    networks:
      - arbor-zitadel
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - traefik.docker.network=arbor-zitadel
      - traefik.http.services.zitadel-api.loadbalancer.server.port=8080
      - traefik.http.services.zitadel-api.loadbalancer.server.scheme=h2c

      # /api → strip prefix and route to API
      - traefik.http.middlewares.zitadel-strip-api.stripprefix.prefixes=/api
      - traefik.http.middlewares.zitadel-strip-api.stripprefix.forceSlash=false
      - traefik.http.routers.zitadel-api-alias.rule=Host(`${ZITADEL_DOMAIN:-localhost}`) && PathPrefix(`/api`)
      - traefik.http.routers.zitadel-api-alias.entrypoints=web
      - traefik.http.routers.zitadel-api-alias.middlewares=zitadel-strip-api
      - traefik.http.routers.zitadel-api-alias.service=zitadel-api
      - traefik.http.routers.zitadel-api-alias.priority=200

      # Catch-all → API (console, well-known, OIDC endpoints)
      - traefik.http.routers.zitadel-canonical.rule=Host(`${ZITADEL_DOMAIN:-localhost}`) && !PathPrefix(`/ui/v2/login`) && !PathPrefix(`/api`) && !Path(`/`)
      - traefik.http.routers.zitadel-canonical.entrypoints=web
      - traefik.http.routers.zitadel-canonical.service=zitadel-api
      - traefik.http.routers.zitadel-canonical.priority=100

  zitadel-login:
    image: ghcr.io/zitadel/zitadel-login:${ZITADEL_VERSION:-v4.11.0}
    restart: unless-stopped
    user: "0"
    environment:
      ZITADEL_API_URL: http://zitadel-api:8080
      NEXT_PUBLIC_BASE_PATH: /ui/v2/login
      ZITADEL_SERVICE_USER_TOKEN_FILE: /zitadel/bootstrap/login-client.pat
      CUSTOM_REQUEST_HEADERS: "Host:${ZITADEL_DOMAIN:-localhost},X-Forwarded-Proto:http"
    healthcheck:
      test: [CMD, /bin/sh, -c, "node /app/healthcheck.js http://localhost:3000/ui/v2/login/healthy"]
      interval: 10s
      timeout: 30s
      retries: 12
      start_period: 20s
    volumes:
      - zitadel-bootstrap:/zitadel/bootstrap:ro
    networks:
      - arbor-zitadel
    depends_on:
      zitadel-api:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - traefik.docker.network=arbor-zitadel
      - traefik.http.services.zitadel-login.loadbalancer.server.port=3000

      # Root → redirect to login UI
      - traefik.http.middlewares.zitadel-root-rewrite.replacepath.path=/ui/v2/login/
      - traefik.http.routers.zitadel-root.rule=Host(`${ZITADEL_DOMAIN:-localhost}`) && Path(`/`)
      - traefik.http.routers.zitadel-root.entrypoints=web
      - traefik.http.routers.zitadel-root.middlewares=zitadel-root-rewrite
      - traefik.http.routers.zitadel-root.service=zitadel-login
      - traefik.http.routers.zitadel-root.priority=400

      # /ui/v2/login → Login UI
      - traefik.http.routers.zitadel-login.rule=Host(`${ZITADEL_DOMAIN:-localhost}`) && PathPrefix(`/ui/v2/login`)
      - traefik.http.routers.zitadel-login.entrypoints=web
      - traefik.http.routers.zitadel-login.service=zitadel-login
      - traefik.http.routers.zitadel-login.priority=250

  postgres:
    image: ${POSTGRES_IMAGE:-postgres:17.2-alpine}
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ADMIN_PASSWORD:-postgres}
      POSTGRES_USER: ${POSTGRES_ADMIN_USER:-postgres}
    healthcheck:
      test: [CMD-SHELL, pg_isready -U postgres]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - arbor-zitadel

networks:
  arbor-zitadel:
    name: arbor-zitadel

volumes:
  postgres-data:
  zitadel-bootstrap:
