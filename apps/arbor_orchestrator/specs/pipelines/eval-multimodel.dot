// Multi-Model Eval Pipeline
// Evaluates multiple LLM models against a dataset, persists results to Postgres.
// Uses the map handler to iterate over a list of {model, provider} pairs.
//
// Usage:
//   Engine.run(graph, initial_values: %{
//     "eval.models" => Jason.encode!([
//       %{"model" => "kimi-k2.5:cloud", "provider" => "ollama"},
//       %{"model" => "glm-5:cloud", "provider" => "ollama"}
//     ]),
//     "eval.dataset_path" => "priv/eval_datasets/elixir_coding.jsonl",
//     "eval.domain" => "coding"
//   })

digraph EvalMultiModel {
  graph [
    goal="Evaluate coding quality across multiple models and persist to Postgres",
    label="Multi-Model Eval"
  ]

  start [shape=Mdiamond]

  load_dataset [
    type="exec",
    target="action",
    action="eval_pipeline.load_dataset",
    param.path="priv/eval_datasets/elixir_coding.jsonl",
    data_class="internal"
  ]

  iterate_models [
    type="map",
    source_key="eval.models",
    item_key="map.current_item",
    collect_key="eval.all_model_results",
    handler_type="exec",
    handler_attrs="{\"target\": \"action\", \"action\": \"eval_pipeline.run_eval\", \"param.graders\": \"compile_check,functional_test\", \"param.subject\": \"Arbor.Orchestrator.Eval.Subjects.LLM\", \"context_keys\": \"exec.load_dataset.dataset\"}",
    max_concurrency="1",
    on_item_error="collect_nil",
    data_class="internal"
  ]

  aggregate [
    type="exec",
    target="action",
    action="eval_pipeline.aggregate",
    param.metrics="accuracy,mean_score",
    context_keys="exec.iterate_models.results",
    data_class="internal"
  ]

  persist [
    type="exec",
    target="action",
    action="eval_pipeline.persist",
    param.domain="coding",
    context_keys="exec.iterate_models.results,exec.aggregate.metrics",
    data_class="internal"
  ]

  report [
    type="exec",
    target="action",
    action="eval_pipeline.report",
    param.format="markdown",
    param.output_path="eval_reports/multimodel_latest.md",
    context_keys="exec.iterate_models.results,exec.aggregate.metrics",
    data_class="internal"
  ]

  done [shape=Msquare]

  start -> load_dataset -> iterate_models -> aggregate -> persist -> report -> done
}
