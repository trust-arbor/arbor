// Heartbeat JSON Compliance Eval Pipeline
// Tests LLM ability to produce valid JSON responses for heartbeat/background tasks.
//
// Usage:
//   Engine.run(graph, initial_values: %{
//     "eval.provider" => "ollama",
//     "eval.model" => "arcee-ai/trinity-large-preview:free"
//   })

digraph EvalHeartbeat {
  graph [
    goal="Evaluate heartbeat LLM JSON compliance and response speed",
    label="Heartbeat Eval"
  ]

  start [shape=Mdiamond]

  load_dataset [
    type="exec",
    target="action",
    action="eval_pipeline.load_dataset",
    param.path="priv/eval_datasets/heartbeat_json.jsonl",
    data_class="internal"
  ]

  run_eval [
    type="exec",
    target="action",
    action="eval_pipeline.run_eval",
    param.subject="Arbor.Orchestrator.Eval.Subjects.LLM",
    param.graders="json_valid",
    context_keys="exec.load_dataset.dataset",
    data_class="internal"
  ]

  aggregate [
    type="exec",
    target="action",
    action="eval_pipeline.aggregate",
    param.metrics="accuracy,mean_score",
    context_keys="exec.run_eval.results",
    data_class="internal"
  ]

  persist [
    type="exec",
    target="action",
    action="eval_pipeline.persist",
    param.domain="heartbeat",
    context_keys="exec.run_eval.results,exec.aggregate.metrics",
    data_class="internal"
  ]

  done [shape=Msquare]

  start -> load_dataset -> run_eval -> aggregate -> persist -> done
}
